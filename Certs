pipeline {
    agent any

    environment {
        EXPIRY_THRESHOLD = 30
        DOMAIN_LIST = "google.com:443 yahoo.com:443 yourdomain.com:443"
        EMAIL_TO = "yourteam@yourcompany.com"
    }

    stages {
        stage('Check OpenSSL Availability') {
            steps {
                script {
                    def opensslAvailable = sh(script: 'which openssl', returnStatus: true) == 0
                    if (!opensslAvailable) {
                        error "❌ OpenSSL is not installed on the Jenkins agent."
                    } else {
                        echo "✅ OpenSSL is installed."
                    }
                }
            }
        }

        stage('Check Certificate Expiry') {
            steps {
                script {
                    def htmlRows = ""
                    def warningCount = 0
                    def currentEpoch = (System.currentTimeMillis() / 1000).toLong()

                    DOMAIN_LIST.split().each { entry ->
                        def (host, port) = entry.split(":")
                        echo "🔍 Checking certificate for ${host}:${port}"

                        def endDateOutput = sh(
                            script: "echo | openssl s_client -servername $host -connect $host:$port 2>/dev/null | openssl x509 -noout -enddate",
                            returnStdout: true
                        ).trim()

                        def match = endDateOutput =~ /notAfter=(.*)/
                        if (match) {
                            def rawDate = match[0][1].trim()

                            // Convert to epoch seconds via shell (sandbox-safe)
                            def expiryEpoch = sh(
                                script: "date -d '${rawDate}' +%s",
                                returnStdout: true
                            ).trim().toLong()

                            def
